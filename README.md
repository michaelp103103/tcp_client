See comments in tcp_client.c